{% extends 'map/base_map.html'%}
{% load static %}
{% block extra_resources%}

{% endblock %}
{% load i18n %}
{% load has_group %}

{% get_current_language as LANGUAGE_CODE %}
{% get_available_languages as LANGUAGES %}

{% block map %}

<style>
  .open-button {
      display: none; /* Initially hide the hamburger icon */
  }

  /* Media query for mobile devices */
  @media screen and (max-width: 600px) {
      #side-bar {
          display: none; /* Hide the sidebar for mobile devices */
      }

      .open-button {
          display: inline-block; /* Display the hamburger icon for mobile devices */
      }

      #mapid {
          width: 100%;
          height: calc(100vh - 50px); /* Adjust height to accommodate other elements */
      }

      #legend {
          bottom: 10px;
          right: 10px;
          width: calc(100% - 20px); /* Adjust width to avoid overflow */
          position: fixed;
          /* Adjust position for better visibility on mobile */
      }
  }

  /* Media query for tablets and larger screens */
  @media screen and (min-width: 601px) {
      #side-bar {
          width: 250px; /* Set a fixed width for larger screens */
          height: 100vh;
          overflow-y: auto;
          margin-left: 0;
          border-style: none;
          display: block;
      }

      #mapid {
          width: calc(100% - 250px); /* Adjust width to accommodate the sidebar */
          height: 100vh;
          float: right;
      }

      @media (max-width: 768px) {
    #legend {
      max-width: 90vw !important;
      font-size: 0.9rem;
    }
  }
  }

  select {
      /* Reset any styles that might affect the visibility */
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      /* Ensure the dropdown is visible */
      visibility: visible;
      display: block;
  }

  /* Style the legend */
  #legend {
      position: absolute;
      bottom: 50px;
      right: 10px;
      background-color: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
  }
  #legend h4 {
      margin-top: 0;
  }
  #legend div {
      margin-bottom: 5px;
  }

</style>

<!-- <script src="https://unpkg.com/leaflet-pancontrol"></script> -->

<!-- <button class="openbtn" onclick="openNav()">Open/Close <span class="open-button"></span></button> -->
<script defer src="https://use.fontawesome.com/releases/v5.0.8/js/all.js"></script>

<!-- script for leaflet font awesome-->
<script src="{% static 'static1/leaflet.awesome-markers.js' %}"></script>
<link rel="stylesheet" href="{% static 'static1/leaflet.awesome-markers.css' %}" />
<!-- For sweet alerts -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div id="container" style="display: flex; height: 100vh; width: 100%; margin-left:10px;">
  <div id="side-bar">
    <!-- Sidebar content here -->
    <ul id="mobile-nav">
      <br>
      <li><a class="subheader">{% trans "Select Language" %} </a></li>
        <form id="languageFormMobile" action="{% url 'set_language' %}" method="post" style="margin: 0;">
          {% csrf_token %}
          <input name="next" type="hidden" value="{{ redirect_to }}" />
          <div class="input-field" style="margin: 0;">
            <select name="language" id="languageSelectMobile" class="browser-default" style="color: #008000;">
              {% get_language_info_list for LANGUAGES as languages %}
              {% for language in languages %}
                <option value="{{ language.code }}" {% if language.code == LANGUAGE_CODE %}selected="selected"{% endif %}>
                  {{ language.name_local }} ({{ language.code }})
                </option>
              {% endfor %}
            </select>
            <!-- <i class="material-icons right" >arrow_drop_down</i> -->
          </div>
        </form>
      </li>
      
      <br>
      {% if user.is_authenticated %}
      <li><a class="subheader">{% trans "USER AUTHENTICATION" %} {{user.username}}</a></li>
      <li><a href="{% url 'logout' %}" class="custom-link">{% trans "Logout" %}</a></li>
      {% else %}
      <li><a class="subheader">{% trans "USER AUTHENTICATION" %} Guest</a></li>
      <li><a href="{% url 'login' %}" class="custom-link">{% trans "Login" %}</a></li>
      <li><a href="{% url 'register' %}" class="custom-link">{% trans "Register" %}</a></li>
      {% endif %}
      <li><div class="divider"></div></li>
      <br>
      <li><a class="subheader">{% trans "DATA CONTRIBUTION AND FORMS" %}</a></li>
      <li><a href="https://ee.kobotoolbox.org/x/fcnSnW0u" class="custom-link">{% trans "PoshanVaitka Form" %}</a></li>
      <li><a href="{% url 'captvatikapic'%}" class="custom-link">{% trans "Capture PoshanVatikas" %}</a></li>
      <li><a href="{% url 'captwellpic'%}" class="custom-link">{% trans "Capture Wells" %}</a></li>
      <li><a href="{% url 'captseedpic'%}" class="custom-link">{% trans "Capture Seed" %}</a></li>
      <li><a href="{% url 'viewVatikas'%}" class="custom-link">{% trans "View All PoshanVatikas" %}</a></li>
      {% if user.is_authenticated and user|has_group:"MWCD officials" %}
      <li><a href="{% url 'viewSarkariVatikas'%}" class="custom-link" id="view-sarkari-vatikas">{% trans "View MWCD PoshanVatikas" %}</a></li>
      {% endif %}
      <li><a href="{% url 'viewAFIFVatikas'%}" class="custom-link">{% trans "View AFIF PoshanVatikas" %}</a></li>
      <li><a href="{% url 'well_info'%}" class="custom-link">{% trans "View Wells Data" %}</a></li>
      <li><a href="{% url 'viewWells'%}" class="custom-link">{% trans "View Wells" %}</a></li>
      {% if user.is_authenticated %}
      <li><a href="{% url 'archive' %}" class="custom-link"><b>{% trans "Archived PoshanVatikas" %}</b></a></li>
      {% endif %}
      <br>
      <li><div class="divider"></div></li>
      <li><a class="subheader">{% trans "POSHANVATIKA" %}</a></li>
      <li><a href="{% url 'news' %}" class="custom-link">{% trans "Reports(coming soon..)" %}</a></li>
      <li><a href="{% url 'news' %}" class="custom-link">{% trans "Feedback(coming soon..)" %}</a></li>
    </ul>
  </div>
  <div id="mapid">
    <!-- Map content here -->
  </div>

  <!-- Show Legend Button (initially hidden) -->
<button id="show-legend-btn" class="btn btn-sm btn-secondary"
style="position: fixed; bottom: 60px; right: 10px; z-index: 1000; display: none;"
onclick="document.getElementById('legend').style.display='block'; this.style.display='none';">
Show Statistics
</button>
  
<div id="legend" class="leaflet-control leaflet-control-custom" style="position: fixed; bottom: 60px; right: 10px; z-index: 999; padding: 10px; background: white; border: 1px solid #ccc; border-radius: 5px; max-width: 300px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
   <!-- Close Button -->
  <button type="button" class="close" aria-label="Close"
    onclick="document.getElementById('legend').style.display='none'; document.getElementById('show-legend-btn').style.display='block';"
    style="position: absolute; top: 5px; right: 10px; font-size: 1.5rem; border: none; background: none;">
    &times;
  </button> 
  <div style="max-height: 60vh; overflow-y: auto; padding-right: 5px;">
    <centre><b>Statistics</b></centre><br>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
    <!-- Tab navigation -->
    <ul class="nav nav-tabs" id="myTab" role="tablist">
      <li class="nav-item">
        <a class="nav-link" id="poshna-tab" data-toggle="tab" href="#poshna" role="tab" aria-controls="poshna" aria-selected="true">All PoshnaVatikas</a>
      </li>
      <li class="nav-item">
        <a class="nav-link active" id="afif-tab" data-toggle="tab" href="#afif" role="tab" aria-controls="afif" aria-selected="false">AFIF</a>
      </li>
    </ul>
    <!-- Tab content -->
    <div class="tab-content" id="myTabContent">
      <!-- AFIF tab -->
      <div class="tab-pane fade show active" id="afif" role="tabpanel" aria-labelledby="afif-tab">
        <img src="../static/map/images/logo_3.png" width="30px" height="30px"/> AFIF Total Vatikas : {{ vatikascount }}<br>
        <ul>
          {% for entry in AFIF_yearly_counts %}
            <li>Year: {{ entry.year }}, AFIF added: {{ entry.count }}</li>
          {% endfor %}
        </ul>
      </div>
      <!-- PoshnaVatikas tab -->
      <div class="tab-pane fade" id="poshna" role="tabpanel" aria-labelledby="poshna-tab">
        {% if is_view_Vatikas %}
          <img src="../static/map/images/pw_logo.png" width="30px" height="30px"/> PoshnaVatikas added Online: {{ onlinevatikascount|add:vatikascount}}<br>
          <img src="../static/map/images/pw_logo.png" width="30px" height="30px"/> PoshnaVatikas Selling Surplus: {{ sellsurpcount }}<br>
          <img src="../static/map/images/pw_logo.png" width="30px" height="30px"/> Self Consuming PoshanVatikas: {{ selfconscount }}<br>
          <hr>
          <img src="../static/map/images/leaves-icon-13.png" width="30px" height="30px"/> PoshanVatikas added Offline: {{ kobovatiakscount }}<br>
          <hr>
        {% endif %}
      </div>
    </div>
    </div>
  </div>
</div>

<!-- Modal Structure -->
<div id="demo-modal" class="modal bottom-sheet"> 
  <div id="content" class="modal-content"> 
  </div> 
  <div class="modal-footer">
    <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
  </div>
</div> 

<div id="demo-modal1" class="modal bottom-sheet"> 
  <div class="modal-header" style="text-align: right;">
    <a href="#!" class="modal-close waves-effect waves-green btn-flat" style="color: white; text-align: right; font-weight: bold; font-size: 20px;">X</a>
  </div>
  <div id="content1" class="modal-content"> 
  </div> 
</div> 

<!-- <div id="hamburger-icon" class="open-button" onclick="toggleSidebar()">
  <span class="fa fa-bars"></span>
</div> -->



<script>

    let isClicked = false
    var mymap = L.map('mapid').setView([19.7515+1,75.7139+2], 4.5);
    // Create a sidebar control

    var mbAttr = 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
			'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
		mbUrl = 'https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw';

	//var grayscale   = L.tileLayer(mbUrl, {id: 'mapbox/light-v9', tileSize: 512, zoomOffset: -1, attribution: mbAttr}),
  //      streets  = L.tileLayer(mbUrl, {id: 'mapbox/streets-v11', tileSize: 512, zoomOffset: -1, attribution: mbAttr});
        
    // const url = 'https://geonode.communitygis.net/geoserver/ows?service=WFS&version=1.0.0&request=GetFeature&outputFormat=json&typename=geonode:diet_data8jan';
    const url = 'https://geonode.communitygis.in/geoserver/ows?service=WFS&version=1.0.0&request=GetFeature&typename=geonode%3Aposhan_dummy&outputFormat=json&srs=EPSG%3A4326&srsName=EPSG%3A4326&access_token=3r7XCeWunHUOfoyqPxnUNt7XY7ZWHu'
    const url1 = 'https://geonode.communitygis.in/geoserver/ows?service=WFS&version=1.0.0&request=GetFeature&typename=geonode%3AOrganization_wise_Compendium&outputFormat=json&srs=EPSG%3A4326&srsName=EPSG%3A4326&access_token=3r7XCeWunHUOfoyqPxnUNt7XY7ZWHu'

    // L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
		// maxZoom: 18,
		// attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
		// 	'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
		// id: 'mapbox/streets-v11',
		// tileSize: 512,
		// zoomOffset: -1
    // }).addTo(mymap);
    // L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    //   maxZoom: 19,
    //   attribution: '© OpenStreetMap'
    // }).addTo(mymap);
    
    // console.log('l/tilelayer');
    var wms = L.tileLayer.wms('https://dilrmp-jk.communitygis.in/geoserver/geonode/wms', {
				//layer: layer,
        layers: 'geonode:states_in_india',
				format: 'image/png',
				transparent: 'true',
			});
      wms.addTo(mymap);
      //console.log(layers);
      // console.log(wms);
    
    
    // var baseLayers = {
		//"Grayscale": grayscale,
		//"Streets": streets
    //};
    var baseLayers = {};
    let indiaState = L.tileLayer.wms("https://geonode.communitygis.in/geoserver/wms", {
            layers: "geonode:states_in_india",
            format: "image/png",
            transparent: "true",
            tiled: "true",
            opacity: 0.7,
            }
        );
    let indiaDistrict = L.tileLayer.wms("https://geonode.communitygis.in/geoserver/wms", {
        layers: "geonode:all_india_districts_11june2020",
        format: "image/png",
        transparent: "true",
        tiled: "true",
        opacity: 0.7,
        }
    );

    let mahaHighways = L.tileLayer.wms("https://geonode.communitygis.in/geoserver/wms", {
        layers: "geonode:osm_highways",
        format: "image/png",
        transparent: "true",
        tiled: "true",
        opacity: 0.7,
        }
    );

    let mahaSchools = L.tileLayer.wms("https://geonode.communitygis.in/geoserver/wms", {
    layers: "geonode:school16_17_codes_30april2020",
    format: "image/png",
    transparent: "true",
    tiled: "true",
    opacity: 0.7,
    }
);

document.getElementById('view-sarkari-vatikas').addEventListener('click', function(event) {
    event.preventDefault(); // Prevent default link behavior

    // Toggle visibility of mahaSchools layer
    if (mymap.hasLayer(mahaSchools)) {
        mymap.removeLayer(mahaSchools);
    } else {
        mymap.addLayer(mahaSchools);

        mymap.removeLayer(poshanlayerGroup);
        mymap.removeLayer(poshanlayerGroup2);
        mymap.removeLayer(poshanlayerGroup3);
        var maharashtraLatLng = [19.7515, 75.7139];
        mymap.setView(maharashtraLatLng, 8);
        Swal.fire({
            icon: 'info',
            title: 'Data shown for demo purpose only',
            showConfirmButton: false,
            timer: 1500
        });
    }
});
</script>

<script>
//wells
    var wellIcon = L.icon({
            iconUrl: "{% static 'map/images/well.png' %}",
            iconSize:     [30, 40], // size of the icon
            //shadowSize:   [50, 64], // size of the shadow
            iconAnchor:   [25,10], // point of the icon which will correspond to marker's location
            // shadowAnchor: [4, 62],  // the same for the shadow
            popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
        });
    
        
   </script>
   <style>
       .another-popup .leaflet-popup-content-wrapper .leaflet-popup-content{
          width: 200px;
          height:400px;
        }

  /* .another-popup .leaflet-popup-content-wrapper {
  background: beige;
  color: #eee;
  border-radius: 5%;
  border-radius: 0px;
} */
/* .another-popup .leaflet-popup-content-wrapper a {
  color: rgba(200, 200, 200, 0.1);
}
.another-popup .leaflet-popup-tip-container {
  width: 10px;
  height: 105px;

}
.another-popup .leaflet-popup-tip {
  background: beige;
  border: none;
  box-shadow: none;
} */
   </style>
         

<script>
     //poshan
     var pvIcon = L.icon({
            iconUrl: "{% static 'map/images/pw_logo.png' %}",
            iconSize:     [40, 40], // size of the icon
            //shadowSize:   [50, 64], // size of the shadow
            iconAnchor:   [25,10], // point of the icon which will correspond to marker's location
            // shadowAnchor: [4, 62],  // the same for the shadow
            popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
        });

      var poshanlayerGroup = L.layerGroup().addTo(mymap);
</script>

{% for i in vatikas %}

   <script>
      //  alert("in vatikas -" +i+"- "+ +i.nutri_nm) 

    var table1 = 
         
         `<table class="w3-table" id="popup" style="font-size:12px; align:center;" >
           <tbody>
         {% if i.picture %}
           <tr>
             <tr><img src={{ i.picture.url }} alt="No image uploaded" style="height:100px; width:170px; border:2px solid #555;"/>
           </tr>
           {% endif %}
 
           {% if i.organization %}
           <tr>
               <th>Organization name</th>
               <th>{{ i.organization}}</th>
           </tr>
           {% endif %}
           
           {% if i.district %}
           <tr>
             <td>District</td>
             <td>{{ i.district}}</td>
           </tr>
           {% endif %}
 
           {% if i.village %}
           <tr>
             <td>Village</td>
             <td>{{ i.village }}</td>
           </tr>
           {% endif %}
           {% if i.name %}
           <tr>
             <td>Beneficiary Name</td>
             <td>{{ i.name }}</td>
           </tr>
           {% endif %}
           {% if i.one_to_fourthousand_sq %}
           <tr>
             <td>Area of Nutrigarden</td>
             <td>{{ i.one_to_fourthousand_sq }}</td>
           </tr>
           {% endif %}
           <tr>
          
           {% if i.picture %}
            <td><a href="{{ i.picture.url }}" class = "popupimage2" target = "_app"><img src="../static/map/images/icons8-image-48.png"/></a></td>
           {% else %}
            <td><img src="../static/map/images/icons8-image-48.png"/></td>
           {% endif %}  
          
            <td><a href="../download/{{ i.id }}"><img src="../static/map/images/icons8-microsoft-excel-48.png" /></a></td>
             
          
          
          </tr>  
         </tbody>
    </table>
    </br>`
       var popupOptions =
        {
          'maxWidth': '500',
          'className' : 'another-popup' // classname for another popup
        }
        var marker = L.marker(["{{ i.lat }}", "{{ i.lng }}"], {icon:pvIcon}).addTo(mymap).bindPopup(table1, popupOptions);
        poshanlayerGroup.addLayer(marker);
        // Added  hover to open popups
        // marker.on('mouseover', function (e) {
        //       this.openPopup(e.latlng);
        //   });
        // marker.on('mouseout', function (e) {
        //       this.openPopup(e.latlng);
        // });
        marker.on('click', function (e) {
              this.openPopup(e.latlng);
        });

        mymap.on ({
            click: function() {
                isClicked = false
            },
            popupclose: function () {
                isClicked = false
            }
        })
    </script>
{% endfor %}


<script>
  //poshan
  var logo = L.icon({
         iconUrl: "{% static 'map/images/logo_3.png' %}",
         iconSize:     [40, 40], // size of the icon
         //shadowSize:   [50, 64], // size of the shadow
         iconAnchor:   [25,10], // point of the icon which will correspond to marker's location
         // shadowAnchor: [4, 62],  // the same for the shadow
         popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
     });

  var poshanlayerGroup3 = L.layerGroup().addTo(mymap);
</script>

{% for i in vatikas2 %}
 
   <script>
      //  alert("in vatikas -" +i+"- "+ +i.nutri_nm) 

    var table3 = 
         
         `<table class="w3-table" id="popup" style="font-size:12px; align:center;" >
           <tbody>
         {% if i.picture %}
           <tr>
             <tr><img src={{ i.picture.url }} alt="No image uploaded" style="height:100px; width:170px; border:2px solid #555;"/>
           </tr>
           {% endif %}
           {% if i.name %}
           <tr>
             <td>Beneficiary Name</td>
             <td>{{ i.name }}</td>
           </tr>
           {% endif %}
           {% if i.organization %}
           <tr>
               <th>Organization name</th>
               <th>{{ i.organization}}</th>
           </tr>
           {% endif %}
           
           {% if i.district %}
           <tr>
             <td>District</td>
             <td>{{ i.district}}</td>
           </tr>
           {% endif %}
 
           {% if i.village %}
           <tr>
             <td>Village</td>
             <td>{{ i.village }}</td>
           </tr>
           {% endif %}
           <tr>
          
           {% if i.picture %}
            <td><a href="{{ i.picture.url }}" class = "popupimage2" target="_blank"><img src="../static/map/images/icons8-image-48.png"/></a></td>
           {% else %}
            <td><img src="../static/map/images/icons8-image-48.png"/></td>
           {% endif %}  
          
            <td><a href="../download/{{ i.id }}"><img src="../static/map/images/icons8-microsoft-excel-48.png" /></a></td>
         </tbody>
    </table>
    </br>`
       var popupOptions =
        {
          'maxWidth': '500',
          'className' : 'another-popup' // classname for another popup
        }
        var marker = L.marker(["{{ i.lat }}", "{{ i.lng }}"], {icon:logo}).addTo(mymap).bindPopup(table3, popupOptions);
        poshanlayerGroup3.addLayer(marker);
        // Added  hover to open popups
        // marker.on('mouseover', function (e) {
        //       this.openPopup(e.latlng);
        //   });
        // marker.on('mouseout', function (e) {
        //       this.openPopup(e.latlng);
        // });
        marker.on('click', function (e) {
              this.openPopup(e.latlng);
        });

        mymap.on ({
            click: function() {
                isClicked = false
            },
            popupclose: function () {
                isClicked = false
            }
        })
    </script>
{% endfor %}

<script>
  //poshan - myposhanvatikas
  var pvIcon1 = L.icon({
          iconUrl: "{% static 'map/images/pw_logo.png' %}",
          iconSize:     [40, 40], // size of the icon
          //shadowSize:   [50, 64], // size of the shadow
          iconAnchor:   [25,10], // point of the icon which will correspond to marker's location
          // shadowAnchor: [4, 62],  // the same for the shadow
          popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
      });
  var icon1a = L.icon({
      iconUrl: "{% static 'map/images/pw_logo1a.png' %}",
      iconSize:     [40, 40], // size of the icon
      //shadowSize:   [50, 64], // size of the shadow
      iconAnchor:   [25,10], // point of the icon which will correspond to marker's location
      // shadowAnchor: [4, 62],  // the same for the shadow
      popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
  });
  var icon1b = L.icon({
      iconUrl: "{% static 'map/images/pw_logo1b.png' %}",
      iconSize:     [40, 40], // size of the icon
      //shadowSize:   [50, 64], // size of the shadow
      iconAnchor:   [25,10], // point of the icon which will correspond to marker's location
      // shadowAnchor: [4, 62],  // the same for the shadow
      popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
  });
  var icon1c = L.icon({
      iconUrl: "{% static 'map/images/pw_logo1c.png' %}",
      iconSize:     [40, 40], // size of the icon
      //shadowSize:   [50, 64], // size of the shadow
      iconAnchor:   [25,10], // point of the icon which will correspond to marker's location
      // shadowAnchor: [4, 62],  // the same for the shadow
      popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
  });
  var icon2a = L.icon({
    iconUrl:  "{% static 'map/images/pw_logo2a.png' %}",
    iconSize:     [40, 40], // size of the icon
    //shadowSize:   [50, 64], // size of the shadow
    iconAnchor:   [25,10], // point of the icon which will correspond to marker's location
    // shadowAnchor: [4, 62],  // the same for the shadow
    popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
  });
  var icon2b = L.icon({
    iconUrl:  "{% static 'map/images/pw_logo2b.png' %}",
    iconSize:     [40, 40], // size of the icon
    //shadowSize:   [50, 64], // size of the shadow
    iconAnchor:   [25,10], // point of the icon which will correspond to marker's location
    // shadowAnchor: [4, 62],  // the same for the shadow
    popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
  });
  
  var icon2c = L.icon({
    iconUrl:  "{% static 'map/images/pw_logo2c.png' %}",
    iconSize:     [40, 40], // size of the icon
    //shadowSize:   [50, 64], // size of the shadow
    iconAnchor:   [25,10], // point of the icon which will correspond to marker's location
    // shadowAnchor: [4, 62],  // the same for the shadow
    popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
  });
  var icon_kobo = L.icon({
    iconUrl:  "{% static 'map/images/leaves-icon-13.png' %}",
    iconSize:     [30, 30], // size of the icon
    //shadowSize:   [50, 64], // size of the shadow
    iconAnchor:   [25,10], // point of the icon which will correspond to marker's location
    // shadowAnchor: [4, 62],  // the same for the shadow
    popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
  });
  var icon_kobo2 = L.icon({
    iconUrl:  "{% static 'map/images/pw_logo1c.png' %}",
    iconSize:     [30, 30], // size of the icon
    //shadowSize:   [50, 64], // size of the shadow
    iconAnchor:   [25,10], // point of the icon which will correspond to marker's location
    // shadowAnchor: [4, 62],  // the same for the shadow
    popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
  });

    var poshanlayerGroup2 = L.layerGroup().addTo(mymap);

</script>
  <style>
  .another-popup .leaflet-popup-content-wrapper .leaflet-popup-content{
      width: 400px;
      height:auto;
    }

  </style>
  
{% for i in vatikas1 %}
<script>
  var table2 = 
    
    `<table class="table table-bordered table-striped mb-0" id="popup" style="font-size:12px; align:center;" >
      <tbody>
          
      {% if i.organization_name %}
      <tr>
          <th>Organization name</th>
          <th>{{ i.organization_name }}</th>
      </tr>
      
      {% endif %}
      
      
      {% if i.district_village_taluka_name %}
      <tr>
        <td>District/Village</td>
        <td>{{ i.district_village_taluka_name }}</td>
      </tr>
      {% endif %}

        
      {% if i.type_of_nutri %}
      <tr>
        <td>Type of Nutrigarden</td>
        <td>{{ i.type_of_nutri }}</td>
      </tr>
      {% endif %}

      {% if i.area_nutri_garden %}
      <tr>
        <td>Area of Nutrigarden</td>
        <td>{{ i.area_nutri_garden }}</td>
      </tr>
      {% endif %}

      {% if i.level_nutri_garden %}
      <tr>
        <td>Level of Nutrigarden</td>
        <td>{{ i.level_nutri_garden }}</td>
      </tr>
      {% endif %}

      {% if i.nutri_garden_scale %}
      <tr>
        <td>Scale of Nutrigarden</td>
        <td>{{ i.nutri_garden_scale }}</td>
      </tr>
      {% endif %}


      {% if i.seasonal_veg_name %}
      <tr>
        <td>Seasonal Vegetable</td>
        <td>{{ i.seasonal_veg_name }}</td>
      </tr>
      {% endif %}

      {% if i.perennial_veg_name %}
      <tr>
        <td>Perennial Vegetable</td>
        <td>{{ i.perennial_veg_name }}</td>
      </tr>
      {% endif %}

      {% if i.fruits_name %}
      <tr>
        <td>Fruits Name</td>
        <td>{{ i.fruits_name }}</td>
      </tr>
      {% endif %}

      {% if i.month_earnings %}
      <tr>
        <td>Monthly Earnings</td>
        <td>{{ i.month_earnings }}</td>
      </tr>
      {% endif %}
    </tbody>
  </table>
  </br>

  {% if i.level_nutri_garden == "selling_surplus" and i.nutri_garden_scale == "backyard_poultry" %}`
     var iconvar = icon2b;
  `{% elif i.level_nutri_garden == "for_self_consumption" and i.nutri_garden_scale == "only_for_vegetables_and_fruits backyard_poultry" %}`
      var iconvar = icon1b;
  `{% elif i.level_nutri_garden == "for_self_consumption selling_surplus" and i.nutri_garden_scale == "only_for_vegetables_and_fruits backyard_poultry backyard_fishery other" %}`
     var iconvar = icon1c;
  `{% else %}`
     var iconvar = pvIcon1;
  `{% endif %}`
  // var iconvar = pvIcon1;
 
  var popupOptions =
  {
    'maxWidth': '500',
    'className' : 'another-popup' // classname for another popup
  }
  // var marker = L.marker(["{{ i.lat }}", "{{ i.lng }}"], {icon:iconvar}).addTo(mymap).bindPopup(table2, popupOptions);
  // var marker = L.marker(["{{ i.lat }}", "{{ i.lng }}"], {icon:iconvar}).addTo(mymap);
  // poshanlayerGroup1.addLayer(marker);
  
// Added  hover to open popups
  // marker.on('mouseover', function (e) {
  //       this.openPopup(e.latlng);
  //   });
  // marker.on('mouseout', function (e) {
  //       this.openPopup(e.latlng);
  // });
  marker.on('click', function (e) {
        this.openPopup(e.latlng);
  });

  mymap.on ({
      click: function() {
          isClicked = false
      },
      popupclose: function () {
          isClicked = false
      }
  })

//hover end
  </script>
{% endfor %}
      
<script>
  var selfconvatikaslayerGroup = L.layerGroup();
</script>
{% for i in selfcons %}
<script>
var table = 
        
        `<table class="w3-table" id="popup" style="font-size:12px; align:center;" >
          <tbody>
           
            {% if i.organization_name %}
         <tr>
          <th>Organization name</th>
          <th>{{ i.organization_name }}</th>
          </tr>
      
      {% endif %}      
      
      {% if i.district_village_taluka_name %}
      <tr>
        <td>District/Village</td>
        <td>{{ i.district_village_taluka_name }}</td>
      </tr>
      {% endif %}

        
      {% if i.type_of_nutri %}
      <tr>
        <td>Type of Nutrigarden</td>
        <td>{{ i.type_of_nutri }}</td>
      </tr>
      {% endif %}

      {% if i.area_nutri_garden %}
      <tr>
        <td>Area of Nutrigarden</td>
        <td>{{ i.area_nutri_garden }}</td>
      </tr>
      {% endif %}

      
    </tbody>
  </table>

      </br>`
      var popupOptions =
    {
      'maxWidth': '500',
      'className' : 'another-popup' // classname for another popup
    }
       var marker = L.marker(["{{ i.lat }}", "{{ i.lng }}"], {icon:icon2c}).bindPopup(table, popupOptions);
       selfconvatikaslayerGroup.addLayer(marker);
</script>
{% endfor %}

<script>
  var sellsurpluslayerGroup = L.layerGroup();
</script>
{% for i in sellsurp %}
<script>
var table = 
        
        `<table class="w3-table" id="popup" style="font-size:12px; align:center;" >
          <tbody>
            {% if i.organization_name %}
         <tr>
          <th>Organization name</th>
          <th>{{ i.organization_name }}</th>
          </tr>
      
      {% endif %}      
      
      {% if i.district_village_taluka_name %}
      <tr>
        <td>District/Village</td>
        <td>{{ i.district_village_taluka_name }}</td>
      </tr>
      {% endif %}

        
      {% if i.type_of_nutri %}
      <tr>
        <td>Type of Nutrigarden</td>
        <td>{{ i.type_of_nutri }}</td>
      </tr>
      {% endif %}

      {% if i.area_nutri_garden %}
      <tr>
        <td>Area of Nutrigarden</td>
        <td>{{ i.area_nutri_garden }}</td>
      </tr>
      {% endif %}

      {% if i.area_nutri_garden %}
      <tr>
        <td>Area of Nutrigarden</td>
        <td>{{ i.area_nutri_garden }}</td>
      </tr>
      {% endif %}

      {% if i.area_nutri_garden %}
      <tr>
        <td>Area of Nutrigarden</td>
        <td>{{ i.area_nutri_garden }}</td>
      </tr>
      {% endif %}

      {% if i.area_nutri_garden %}
      <tr>
        <td>Area of Nutrigarden</td>
        <td>{{ i.area_nutri_garden }}</td>
      </tr>
      {% endif %}
      
    </tbody>
  </table>

      </br>`
      var popupOptions =
    {
      'maxWidth': '500',
      'className' : 'another-popup' // classname for another popup
    }
       var marker = L.marker(["{{ i.lat }}", "{{ i.lng }}"], {icon:pvIcon}).bindPopup(table, popupOptions);
       sellsurpluslayerGroup.addLayer(marker);
   </script>
{% endfor %}
<!-- Added for kobo_poshan - Kobo Form -->
{% for i in vatikas3 %}
<script>
  var table4 = 
    
    `<table class="table table-bordered table-striped mb-0" id="popup" style="font-size:12px; align:center;" >
      <tbody>
      
        {% if i.picture %}
           <tr>
             <tr><img src=../media/kobo_poshan_pics/{{i.picture}} alt="Image not Uploaded" style="height:100px; width:170px; border:2px solid #555;"/>
           </tr>
           {% endif %}  

      {% if i.organization %}
      <tr>
          <th>Beneficiary name</th>
          <th>{{ i.organization }}</th>
      </tr>
      
      {% endif %}

      {% if i.org_name_school %}
      <tr>
          <th>Organisation name</th>
          <th>{{ i.org_name_school }}</th>
      </tr>
      
      {% endif %}
      
      
      {% if i.district %}
      <tr>
        <td>District</td>
        <td>{{ i.district }}</td>
      </tr>
      {% endif %}

      {% if i.pincode %}
      <tr>
        <td>Pincode</td>
        <td>{{ i.pincode }}</td>
      </tr>
      {% endif %}

      {% if i.type_nutri %}
      <tr>
        <td>Type of Nutrigarden</td>
        <td>{{ i.type_nutri }}</td>
      </tr>
      {% endif %}

      {% if i.nutri_area %}
      <tr>
        <td>Area of Nutrigarden</td>
        <td>{{ i.nutri_area }}</td>
      </tr>
      {% endif %}

      {% if i.type_nutri %}
      <tr>
        <td>Type of Nutrigarden</td>
        <td>{{ i.type_nutri }}</td>
      </tr>
      {% endif %}

      {% if i.local_ngo %}
      <tr>
        <td>Name of Local NGO giving Support</td>
        <td>{{ i.local_ngo }}</td>
      </tr>
      {% endif %}

      {% if i.level_nutri %}
      <tr>
        <td>Level of Nutrigarden</td>
        <td>{{ i.level_nutri }}</td>
      </tr>
      {% endif %}

      {% if i.nutri_scale %}
      <tr>
        <td>Scale of Nutrigarden</td>
        <td>{{ i.nutri_scale }}</td>
      </tr>
      {% endif %}
      
      {% if i.seasonal_veg %}
      <tr>
        <td>Seaonal Vegetables</td>
        <td>{{ i.seasonal_veg }}</td>
      </tr>
      {% endif %}

      {% if i.perennial_veg %}
      <tr>
        <td>Perennial Vegetables</td>
        <td>{{ i.perennial_veg }}</td>
      </tr>
      {% endif %}

      {% if i.earning_per_month %}
      <tr>
        <td>Earning Per Month</td>
        <td>{{ i.earning_per_month }}</td>
      </tr>
      {% endif %}

      {% if i.monthly_expenses %}
      <tr>
        <td>Expenses per Month</td>
        <td>{{ i.monthly_expenses }}</td>
      </tr>
      {% endif %}

      {% if i.water_source %}
      <tr>
        <td>Source of Irrigation</td>
        <td>{{ i.water_source }}</td>
      </tr>
      {% endif %}
    </tbody>
  </table>
  </br>`

  
  // var iconvar = pvIcon1;
  var iconvar = icon_kobo;
  // pattern = i.lat_lng;
  c = "{{i.lat_lng}}".split(sep=' ');
  lat = c[0];
  lng = c[1];
  // console.log("cordinates : ",c[0],"+",c[1]);

  var popupOptions =
  {
    'maxWidth': '500',
    'className' : 'another-popup' // classname for another popup
  }
  var marker = L.marker([lat,lng], {icon:iconvar}).addTo(mymap).bindPopup(table4, popupOptions);
  // var marker = L.marker(["{{ i.lat }}", "{{ i.lng }}"], {icon:iconvar}).addTo(mymap);
  poshanlayerGroup2.addLayer(marker);
  
// Added  hover to open popups
  // marker.on('mouseover', function (e) {
  //       this.openPopup(e.latlng);
  //   });
  // marker.on('mouseout', function (e) {
  //       this.openPopup(e.latlng);
  // });
  marker.on('click', function (e) {
        this.openPopup(e.latlng);
  });

  mymap.on ({
      click: function() {
          isClicked = false
      },
      popupclose: function () {
          isClicked = false
      }
  })

//hover end
  </script>
{% endfor %}
      

<!-- kobo -poshan ends -->

<!-- Kobo poshan 2 -->


 <!-- Added for kobo_poshan2 - Kobo Form new -->
{% for i in vatikas3a %}
<script>
  var table4a = 
    
    `<table class="table table-bordered table-striped mb-0" id="popup" style="font-size:12px; align:center;" >
      <tbody>
      
        {% if i.picture %}
           <tr>
             <tr><img src="../media/kobo_poshan_pics/{{i.picture}}" alt="Image not Uploaded" style="height:100px; width:170px; border:2px solid #555;"/>
           </tr>
           {% endif %}  

      {% if i.owner %}
      <tr>
          <th>Beneficiary name</th>
          <th>{{ i.owner }}</th>
      </tr>
      
      {% endif %}
       {% if i.state %}
      <tr>
          <th>State</th>
          <th>{{ i.state }}</th>
      </tr>
      
      {% endif %}
       {% if i.district %}
      <tr>
          <th>District</th>
          <th>{{ i.district }}</th>
      </tr>
      
      {% endif %}
      {% if i.tehsil %}
      <tr>
          <th>Tehsil</th>
          <th>{{ i.tehsil }}</th>
      </tr>
      
      {% endif %}
      {% if i.nutri_area %}
      <tr>
          <th>Area of nutrigarden</th>
          <th>{{ i.nutri_area }}</th>
      </tr>
      
      {% endif %}
      {% if i.variety_num %}
      <tr>
          <th>Number of Varieties grown</th>
          <th>{{ i.variety_num }}</th>
      </tr>
      
      {% endif %}
      {% if i.variety_list %}
      <tr>
          <th>List of varieties</th>
          <th>{{ i.variety_list }}</th>
      </tr>
      
      {% endif %}
      {% if i.seed_type %}
      <tr>
          <th>Type of seed</th>
          <th>{{ i.seed_type }}</th>
      </tr>
      
      {% endif %}
      {% if i.seed_source %}
      <tr>
          <th>Source of seed</th>
          <th>{{ i.seed_source }}</th>
      </tr>
      
      {% endif %}
      {% if i.est_yield %}
      <tr>
          <th>Estimated Yield</th>
          <th>{{ i.est_yield }}</th>
      </tr>
      
      {% endif %}
      {% if i.support %}
      <tr>
          <th>External support</th>
          <th>{{ i.support }}</th>
      </tr>
      
      {% endif %}
      {% if i.afif_support %}
      <tr>
          <th>Support from AFIF </th>
          <th>{{ i.afif_support }}</th>
      </tr>
      
      {% endif %}
      

     
    </tbody>
  </table>
  </br>`
  var iconvar = icon_kobo2;
  // pattern = i.lat_lng;
  c = "{{i.lat_lng}}".split(sep=' ');
  lat = c[0];
  lng = c[1];
  // console.log("cordinates : ",c[0],"+",c[1]);

  var popupOptions =
  {
    'maxWidth': '500',
    'className' : 'another-popup' // classname for another popup
  }
  var marker = L.marker([lat,lng], {icon:iconvar}).addTo(mymap).bindPopup(table4a, popupOptions);
  // var marker = L.marker(["{{ i.lat }}", "{{ i.lng }}"], {icon:iconvar}).addTo(mymap);
  poshanlayerGroup2.addLayer(marker);
  marker.on('click', function (e) {
        this.openPopup(e.latlng);
  });

  mymap.on ({
      click: function() {
          isClicked = false
      },
      popupclose: function () {
          isClicked = false
      }
  })

//hover end
  </script>
{% endfor %}
 <!-- kobo poshan 2 ends-->
<script>
  var schoolIcon = L.icon({
        iconUrl: "{% static 'map/images/leaf-icon-forschool.png' %}",  // Replace with the path to your school icon
        iconSize: [25, 25], // Adjust the size as needed
        iconAnchor: [12, 12], // Point of the icon which will correspond to marker's location
        popupAnchor: [0, -12] // Point from which the popup should open relative to the iconAnchor
    });

    // Create a LayerGroup for schools
    var schoolLayerGroup = L.layerGroup().addTo(mymap);

// Add event listener for map clicks
mymap.on('click', function(e) {
    var latlng = e.latlng;
    console.log(`Map clicked at [${latlng.lat}, ${latlng.lng}]`);

    // Check if clicked on WMS layer
    var url = 'https://geonode.communitygis.in/geoserver/wms';
    var layerName = 'geonode:school16_17_codes_30april2020';

    var featureInfoUrl = `${url}?service=WMS&version=1.1.1&request=GetFeatureInfo&layers=${layerName}&bbox=${mymap.getBounds().toBBoxString()}&width=${mymap.getSize().x}&height=${mymap.getSize().y}&srs=EPSG:4326&query_layers=${layerName}&info_format=application/json&x=${Math.round(mymap.layerPointToContainerPoint(e.layerPoint).x)}&y=${Math.round(mymap.layerPointToContainerPoint(e.layerPoint).y)}`;

    // Fetch the feature info
    fetch(featureInfoUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok ' + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            // console.log('Fetched GetFeatureInfo data:', data); // Debug: log fetched data

            if (data.features && data.features.length > 0) {
                var feature = data.features[0];
                var properties = feature.properties;

                var schoolPopupContent = `
                    <table class="w3-table" style="font-size:12px; align:center;">
                        <tbody>
                            <tr>
                                <td><strong>Name:</strong></td>
                                <td>${properties.school_nam || 'N/A'}</td>
                            </tr>
                            <tr>
                                <td><strong>Village Name:</strong></td>
                                <td>${properties.village_na || 'N/A'}</td>
                            </tr>
                            <tr>
                                <td><strong>District:</strong></td>
                                <td>${properties.distname || 'N/A'}</td>
                            </tr>
                            
                            <tr>
                                <td><strong>School Code:</strong></td>
                                <td>${properties.school_cod || 'N/A'}</td>
                            </tr>
                        </tbody>
                    </table>
                `;

                var schoolMarker = L.marker(latlng, { icon: schoolIcon })
                    .bindPopup(schoolPopupContent, { maxWidth: 200 })
                    .addTo(schoolLayerGroup);

                // Open the popup on marker click
                schoolMarker.on('click', function() {
                    this.openPopup();
                });
            } else {
                console.log('No school data at clicked location.');
            }
        })
        .catch(error => {
            console.error('Error fetching WMS GetFeatureInfo data:', error);
        });
});
    
//hover end
  </script>

<script>
  
  

  
  var overlays = {
        //"States":indiaState,
        "Districts":indiaDistrict,
        "Maharashtra Highways":mahaHighways,
        "Maharashtra Schools":mahaSchools,
        "PoshanVatikas": poshanlayerGroup,
        "AFIF": poshanlayerGroup3,
        "Poshanvatikas(Kobo form)":poshanlayerGroup2,
        // "Self Consumption Vatiaks":selfconvatikaslayerGroup,
        // "Selling Surplus Vatikas":sellsurpluslayerGroup
	};
 
        
	
document.addEventListener('DOMContentLoaded', () => {
    var elems = document.querySelectorAll('.modal');
    var instances = M.Modal.init(elems, {opacity:.3});
});

// function openNav() {
//     // Code to open the side navigation menu or sidebar
//     // document.getElementById("side-bar").style.width = "250px"; // Set the width of the sidebar
//     // document.getElementById("mapid").style.marginLeft = "250px"; // Adjust the margin of the main content to accommodate the sidebar
//     mySideBar = document.getElementById('side-bar');
//   if (mySideBar.style.display === 'none') {
//     mySideBar.style.display = 'block';
//         } else {
//           mySideBar.style.display = 'none';
//         }
// }
function openNav() {
        var sidebar = document.getElementById("side-bar");
        sidebar.style.display = (sidebar.style.display === "block") ? "none" : "block";
    }
L.control.layers(baseLayers, overlays).addTo(mymap);
 

</script>

<script>
  
  // Define a custom control for closing the sidebar
  var CloseControl = L.Control.extend({
      onAdd: function(map) {
          var container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
          container.innerHTML = '<button class="btn btn-primary" onclick="openNav()"><span class ="fa fa-bars"></span> </button>';
          
          return container;
      }
  });

  // Add the custom close control to the map
  new CloseControl({ position: 'topleft' }).addTo(mymap);
  </script>


{% endblock map%}